# k3s Server Configuration
# Generated by Ansible for {{ inventory_hostname }}

# Cluster configuration
cluster-cidr: "{{ cluster_cidr }}"
service-cidr: "{{ service_cidr }}"
cluster-dns: "{{ cluster_dns }}"

# etcd configuration for HA - k3s uses embedded etcd by default
# Explicitly enable etcd by not setting datastore-endpoint
# datastore-endpoint: ""  # Commented out - empty means embedded etcd

# Network configuration
flannel-backend: vxlan
{% if not is_first_controller %}
server: "https://{{ hostvars[first_controller]['ansible_host'] }}:6443"
{% endif %}

# Token for cluster authentication
token: "{{ k3s_token | default(ansible_env.K3S_TOKEN) }}"

# Data directory
data-dir: "{{ k3s_data_dir }}"

# Disable components we don't need
disable:
  - traefik
  - local-storage
  - metrics-server

# Enable features we need
kube-apiserver-arg:
  - "enable-admission-plugins=NodeRestriction,MutatingAdmissionWebhook,ValidatingAdmissionWebhook"
  - "audit-log-path=/var/log/audit.log"
  - "audit-log-maxage=30"
  - "audit-log-maxbackup=3"
  - "audit-log-maxsize=100"

# etcd configuration
etcd-expose-metrics: true
etcd-disable-snapshots: false
etcd-snapshot-schedule-cron: "0 */6 * * *"
etcd-snapshot-retention: 5
etcd-snapshot-dir: "{{ etcd_data_dir }}/snapshots"

# Logging
log: "/var/log/k3s.log"

# Node configuration
node-name: "{{ inventory_hostname }}"
node-ip: "{{ ansible_host }}"

# TLS configuration
tls-san:
{% for ip in controller_ips %}
  - "{{ ip }}"
{% endfor %}
{% for host in groups['controllers'] %}
  - "{{ host }}"
{% endfor %}

# Additional server configuration
write-kubeconfig-mode: "0644"
kubelet-arg:
  - "max-pods=110"
  - "kube-reserved=cpu=200m,memory=512Mi"
  - "system-reserved=cpu=200m,memory=512Mi"
