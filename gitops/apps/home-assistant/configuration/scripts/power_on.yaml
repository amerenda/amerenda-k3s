scheduled_light_on:
  alias: "Scheduled Light On (safe)"
  mode: "restart"
  fields:
    custom_schedule_enabled: { required: false }
    custom_s1_start: { required: false }
    custom_s2_start: { required: false }
    custom_s3_start: { required: false }
    custom_s4_start: { required: false }
    transition: { required: false }
    fallback_lights: { required: false }
    timer_mode: { required: false, default: false }
    auto_on: { required: false, default: false }
  sequence:
  sequence:
    - variables:
        # Extract room/entity name early to look up helpers
        _fb_entity_raw: "{{ fallback_lights | default('') }}"
        _fb_entity: >-
          {% set fb = _fb_entity_raw %}
          {% if fb is mapping and 'entity_id' in fb %}
            {{ fb.entity_id }}
          {% elif fb is mapping %}
            {{ '' }}
          {% elif fb is string %}
            {{ fb }}
          {% else %}
            {{ '' }}
          {% endif %}
        room: >-
          {% set entity = _fb_entity %}
          {% if entity is string and entity != '' and entity|length >= 6 and entity[:6] == 'light.' %}
            {{ entity[6:] }}
          {% else %}
            {{ entity }}
          {% endif %}

        # Global Defaults
        global_s1: "{{ states('input_datetime.global_morning_start') }}"
        global_s2: "{{ states('input_datetime.global_day_start') }}"
        global_s3: "{{ states('input_datetime.global_evening_start') }}"
        global_s4: "{{ states('input_datetime.global_night_start') }}"

        # Master Custom Switch
        use_custom_schedule: >-
          {% set helper = 'input_boolean.' ~ room ~ '_custom_schedule' %}
          {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable', None, ''] else false }}

        # Per-Slot Custom Switches
        use_custom_s1: >-
          {% set helper = 'input_boolean.' ~ room ~ '_morning_custom_time' %}
          {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
        use_custom_s2: >-
          {% set helper = 'input_boolean.' ~ room ~ '_day_custom_time' %}
          {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
        use_custom_s3: >-
          {% set helper = 'input_boolean.' ~ room ~ '_evening_custom_time' %}
          {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
        use_custom_s4: >-
          {% set helper = 'input_boolean.' ~ room ~ '_night_custom_time' %}
          {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}

        # Resolve Times
        s1_str: >-
          {% if use_custom_schedule and use_custom_s1 %}
            {% set v = states('input_datetime.' ~ room ~ '_s1_start') %}
            {{ v if v not in ['unknown', 'unavailable', '', None] else global_s1 }}
          {% elif custom_s1_start is defined and custom_s1_start != '' %}
             {{ states(custom_s1_start) }}
          {% else %}
             {{ global_s1 }}
          {% endif %}

        s2_str: >-
          {% if use_custom_schedule and use_custom_s2 %}
            {% set v = states('input_datetime.' ~ room ~ '_s2_start') %}
            {{ v if v not in ['unknown', 'unavailable', '', None] else global_s2 }}
          {% elif custom_s2_start is defined and custom_s2_start != '' %}
             {{ states(custom_s2_start) }}
          {% else %}
             {{ global_s2 }}
          {% endif %}

        s3_str: >-
          {% if use_custom_schedule and use_custom_s3 %}
            {% set v = states('input_datetime.' ~ room ~ '_s3_start') %}
            {{ v if v not in ['unknown', 'unavailable', '', None] else global_s3 }}
          {% elif custom_s3_start is defined and custom_s3_start != '' %}
             {{ states(custom_s3_start) }}
          {% else %}
             {{ global_s3 }}
          {% endif %}

        s4_str: >-
          {% if use_custom_schedule and use_custom_s4 %}
            {% set v = states('input_datetime.' ~ room ~ '_s4_start') %}
            {{ v if v not in ['unknown', 'unavailable', '', None] else global_s4 }}
          {% elif custom_s4_start is defined and custom_s4_start != '' %}
             {{ states(custom_s4_start) }}
          {% else %}
             {{ global_s4 }}
          {% endif %}

        now_ts: "{{ as_timestamp(now()) }}"
        s1: "{{ as_timestamp(today_at(s1_str)) }}"
        s2: "{{ as_timestamp(today_at(s2_str)) }}"
        s3: "{{ as_timestamp(today_at(s3_str)) }}"
        s4: "{{ as_timestamp(today_at(s4_str)) }}"

        # Global Schedule Entity Logic
        global_slot: >-
          {% if is_state('schedule.scenes_night', 'on') %}night
          {% elif is_state('schedule.scenes_evening', 'on') %}evening
          {% elif is_state('schedule.scenes_day', 'on') %}day
          {% elif is_state('schedule.scenes_morning', 'on') %}morning
          {% else %}night{% endif %}

        slot: >-
          {% if use_custom_schedule %}
            {% if now_ts >= s1 and now_ts < s2 %}morning
            {% elif now_ts >= s2 and now_ts < s3 %}day
            {% elif now_ts >= s3 and now_ts < s4 %}evening
            {% else %}night{% endif %}
          {% else %}
            {{ global_slot }}
          {% endif %}

        _entity_name: "{{ room }}"
        
        _override_select: "{{ 'input_select.' ~ room ~ '_' ~ slot ~ '_scene' }}"
        _override_val: >-
          {% set val = states(_override_select) if _entity_name and _entity_name != '' else '' %}
          {{ '' if val in ['unknown','unavailable','', None] else val }}

        default_scene_entity_id: "scene.{{ _entity_name }}_{{ slot }}"
        scene_to_activate: "{{ _override_val if _override_val else default_scene_entity_id }}"
        scene_exists: >-
          {{ scene_to_activate in (states.scene | map(attribute='entity_id') | list) if scene_to_activate else false }}
        
        scene_cycle_helper: >-
          {% if _entity_name and _entity_name != '' %}
            input_select.{{ _entity_name }}_scene_cycle
          {% else %}
            ''
          {% endif %}

        all_lights: "{{ states.light | map(attribute='entity_id') | list }}"
        dynamic_fallback: >-
          {% set fb = _fb_entity %}
          {% if fb and fb != '' %}
            {{ fb }}
          {% else %}
            {{ '' }}
          {% endif %}
        
        # Check if lights are on (for timer mode)
        timer_mode_active: "{{ timer_mode | default(false) | bool }}"
        lights_on_check: >-
          {% if timer_mode_active %}
            {% if dynamic_fallback %}
              {% set fb_entity = dynamic_fallback %}
              {% if fb_entity is string and fb_entity != '' %}
                {% set expanded = expand(fb_entity) %}
                {{ expanded | selectattr('state','eq','on') | list | count > 0 }}
              {% else %}
                {{ false }}
              {% endif %}
            {% else %}
              {{ false }}
            {% endif %}
          {% else %}
            {{ true }}
          {% endif %}
    
    # Debug logging
    - service: "logbook.log"
      data:
        name: "scheduled_light_on"
        message: >-
          Script called: timer_mode={{ timer_mode | default('NOT_SET') }}, 
          fallback_lights={{ fallback_lights | default('NOT_SET') }}, 
          scene={{ scene_to_activate }}, scene_exists={{ scene_exists }}, 
          lights_on_check={{ lights_on_check }}
    
    - choose:
        - conditions: "{{ scene_exists and lights_on_check | bool }}"
          sequence:
            - service: "logbook.log"
              data:
                name: "scheduled_light_on"
                message: >-
                  ACTIVATING SCENE: {{ scene_to_activate }} 
                  (scene_exists={{ scene_exists }}, lights_on_check={{ lights_on_check }})
            - parallel:
                - service: "scene.turn_on"
                  data:
                    transition: "{{ transition | default(0) }}"
                  target:
                    entity_id: "{{ scene_to_activate }}"
                - if:
                    - condition: template
                      value_template: "{{ scene_cycle_helper != '' }}"
                  then:
                    - service: "input_select.select_option"
                      target:
                        entity_id: "{{ scene_cycle_helper }}"
                      data:
                        option: "{{ slot }}"
            - service: "logbook.log"
              data:
                name: "scheduled_light_on"
                message: >-
                  Scene {{ scene_to_activate }} activated successfully
        - conditions: "{{ scene_exists and not lights_on_check | bool }}"
          sequence:
            - choose:
                - conditions: "{{ timer_mode_active and (auto_on | default(false) | bool) }}"
                  sequence:
                    - service: "logbook.log"
                      data:
                        name: "scheduled_light_on"
                        message: >-
                          Lights are off but auto_on=True - turning on lights first, then applying scene
                          (fallback_lights={{ dynamic_fallback }})
                    - service: "light.turn_on"
                      target:
                        entity_id: "{{ dynamic_fallback }}"
                    - service: "logbook.log"
                      data:
                        name: "scheduled_light_on"
                        message: "Lights turned on, now applying scene {{ scene_to_activate }}"
                    - service: "scene.turn_on"
                      data:
                        transition: "{{ transition | default(0) }}"
                      target:
                        entity_id: "{{ scene_to_activate }}"
                    - if:
                        - condition: template
                          value_template: "{{ scene_cycle_helper != '' }}"
                      then:
                        - service: "input_select.select_option"
                          target:
                            entity_id: "{{ scene_cycle_helper }}"
                          data:
                            option: "{{ slot }}"
                    - service: "logbook.log"
                      data:
                        name: "scheduled_light_on"
                        message: >-
                          Scene {{ scene_to_activate }} activated successfully (auto_on enabled)
                - conditions: []
                  sequence:
                    - service: "logbook.log"
                      data:
                        name: "scheduled_light_on"
                        message: >-
                          SKIPPED: Scene '{{ scene_to_activate }}' - lights are off 
                          (lights_on_check={{ lights_on_check }}, auto_on={{ auto_on | default(false) }})
                    - service: "logbook.log"
                      data:
                        name: "scheduled_light_on"
                        message: "Timer mode: Scene '{{ scene_to_activate }}' skipped - lights are off and auto_on is disabled"
      default:
        - service: "logbook.log"
          data:
            name: "scheduled_light_on"
            message: >-
              Scene '{{ scene_to_activate }}' does NOT exist 
              (scene_exists={{ scene_exists }})
        - choose:
            - conditions: "{{ timer_mode_active }}"
              sequence:
                - service: "logbook.log"
                  data:
                    name: "scheduled_light_on"
                    message: >-
                      Timer mode: Scene missing and timer mode enabled - no action taken
                - service: "logbook.log"
                  data:
                    name: "scheduled_light_on"
                    message: "Timer mode: Scene '{{ scene_to_activate }}' missing and timer mode enabled - no action taken"
            - conditions: []
              sequence:
                - choose:
                    - conditions: "{{ dynamic_fallback != '' }}"
                      sequence:
                        - service: "light.turn_on"
                          target:
                            entity_id: "{{ dynamic_fallback }}"
                        - service: "logbook.log"
                          data:
                            name: "scheduled_light_on"
                            message: "Scene '{{ scene_to_activate }}' missing; used '{{ dynamic_fallback }}'"
                            entity_id: "{{ dynamic_fallback }}"
                  default:
                    - service: "logbook.log"
                      data:
                        name: "scheduled_light_on"
                        message: "Scene '{{ scene_to_activate }}' missing; no fallback light entity available"
