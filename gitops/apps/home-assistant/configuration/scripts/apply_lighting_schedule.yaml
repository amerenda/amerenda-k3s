apply_lighting_schedule:
  alias: "Apply Lighting Schedule (Calendar Aware)"
  description: "Routes lighting requests to the correct script based on calendar event settings or manual overrides"
  mode: "restart"
  fields:
    room:
      description: "Room key (e.g., bedroom, living_room)"
      required: true
      selector:
        text: {}
    target_lights:
      description: "Optional target lights (entity or group). Defaults to light.<room>"
      required: false
      selector:
        target:
          entity:
            domain: light
    forced_slot:
      description: "Optional forced slot (morning/day/evening/night). If not provided, uses calendar or calculated slot."
      required: false
      selector:
        select:
          options:
            - morning
            - day
            - evening
            - night
    smooth_override:
      description: "Force smooth transition on/off"
      required: false
      selector:
        boolean: {}
    auto_on_override:
      description: "Force auto-on on/off"
      required: false
      selector:
        boolean: {}

  sequence:
    - variables:
        # 1. Determine the calendar entity
        calendar_entity: "calendar.{{ room }}_lighting"
        
        # 2. Check if a calendar event is currently active
        has_event: "{{ is_state(calendar_entity, 'on') }}"
        event_attrs: "{{ state_attr(calendar_entity, 'all_day') == false and state_attr(calendar_entity, 'message') is not none }}"
        
        # 3. Parse Calendar Description for settings
        # Description format:
        # smooth: true
        # auto_on: true
        # motion: true
        raw_desc: "{{ state_attr(calendar_entity, 'description') | default('') }}"
        
        # Simple YAML-ish parser for description flags
        # Supports "key: true", "key: false", "key: on", "key: off"
        smooth_from_cal: >-
          {% set match = re_findall('smooth:\s*(true|on)', raw_desc, ignorecase=True) %}
          {{ match | length > 0 }}
        auto_on_from_cal: >-
          {% set match = re_findall('auto_on:\s*(true|on)', raw_desc, ignorecase=True) %}
          {{ match | length > 0 }}
        motion_from_cal: >-
          {% set match = re_findall('motion:\s*(true|on)', raw_desc, ignorecase=True) %}
          {{ match | length > 0 }}

        # 4. Resolve the Slot
        # Priority: forced_slot > calendar summary > calculated fallback
        cal_summary: "{{ state_attr(calendar_entity, 'message') | lower if has_event else '' }}"
        valid_slots: ['morning', 'day', 'evening', 'night']
        
        resolved_slot: >-
          {% if forced_slot is defined and forced_slot in valid_slots %}
            {{ forced_slot }}
          {% elif cal_summary in valid_slots %}
            {{ cal_summary }}
          {% else %}
            {# Fallback to old-style time calculation if no calendar event #}
            {% set s1 = as_timestamp(today_at(states('input_datetime.' ~ room ~ '_s1_start') | default('06:00:00'))) %}
            {% set s2 = as_timestamp(today_at(states('input_datetime.' ~ room ~ '_s2_start') | default('09:00:00'))) %}
            {% set s3 = as_timestamp(today_at(states('input_datetime.' ~ room ~ '_s3_start') | default('17:00:00'))) %}
            {% set s4 = as_timestamp(today_at(states('input_datetime.' ~ room ~ '_s4_start') | default('22:00:00'))) %}
            {% set now_ts = as_timestamp(now()) %}
            {% if now_ts >= s1 and now_ts < s2 %}morning
            {% elif now_ts >= s2 and now_ts < s3 %}day
            {% elif now_ts >= s3 and now_ts < s4 %}evening
            {% else %}night{% endif %}
          {% endif %}

        # 5. Resolve Flags
        # Priority: override > calendar > default (false)
        is_smooth: "{{ smooth_override if smooth_override is defined else smooth_from_cal }}"
        is_auto_on: "{{ auto_on_override if auto_on_override is defined else auto_on_from_cal }}"
        
        # 6. Resolve Target Lights
        final_lights: >-
          {% if target_lights is defined and target_lights != '' %}
            {{ target_lights }}
          {% else %}
            light.{{ room }}
          {% endif %}

    # 7. Debug Log
    - service: logbook.log
      data:
        name: "apply_lighting_schedule"
        message: >-
          Room: {{ room }}, Slot: {{ resolved_slot }}, Smooth: {{ is_smooth }}, 
          Auto-On: {{ is_auto_on }}, Calendar-Event: {{ has_event }}

    # 8. Execute appropriate script
    - choose:
        - conditions: "{{ is_smooth | bool }}"
          sequence:
            - service: script.smooth_transition
              data:
                room: "{{ room }}"
                target_slot: "{{ resolved_slot }}"
        - conditions: []
          sequence:
            - service: script.scheduled_light_on
              data:
                fallback_lights: "{{ final_lights }}"
                auto_on: "{{ is_auto_on }}"
                forced_slot: "{{ resolved_slot }}"
