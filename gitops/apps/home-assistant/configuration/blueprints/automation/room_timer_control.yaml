blueprint:
  name: "Room - Timer Control (apply scene at window start)"
  description: >
    On each time window start (morning/day/evening/night), optionally auto-turn-on
    or only update scene on currently-on lights. Uses the same shared custom schedule
    as other automations.
  domain: "automation"

  input:
    room_key:
      name: "Room Key"
      description: "Short name used by scenes: scene.<room_key>_(morning|day|evening|night)"
      selector: { text: {} }

    target_lights:
      name: "Target lights (group or list)"
      selector: { target: { entity: { domain: "light" } } }

    # Shared schedule helpers
    custom_schedule_enabled:
      name: "(Optional) Custom schedule enabled boolean"
      default:
      selector: { entity: { domain: "input_boolean" } }
    custom_s1_start:
      name: "(Optional) Morning start (time-only)"
      default:
      selector: { entity: { domain: "input_datetime" } }
    custom_s2_start:
      name: "(Optional) Day start (time-only)"
      default:
      selector: { entity: { domain: "input_datetime" } }
    custom_s3_start:
      name: "(Optional) Evening start (time-only)"
      default:
      selector: { entity: { domain: "input_datetime" } }
    custom_s4_start:
      name: "(Optional) Night start (time-only)"
      default:
      selector: { entity: { domain: "input_datetime" } }

    # Per-window controls (helpers; can be shared booleans or per-room ones)
    enable_morning_helper:
      name: "Morning Enabled (input_boolean, default ON if empty)"
      default:
      selector: { entity: { domain: "input_boolean" } }
    auto_on_morning_helper:
      name: "Morning Auto-on (input_boolean, default OFF if empty)"
      default:
      selector: { entity: { domain: "input_boolean" } }

    enable_day_helper:
      name: "Day Enabled (input_boolean, default ON if empty)"
      default:
      selector: { entity: { domain: "input_boolean" } }
    auto_on_day_helper:
      name: "Day Auto-on (input_boolean, default OFF if empty)"
      default:
      selector: { entity: { domain: "input_boolean" } }

    enable_evening_helper:
      name: "Evening Enabled (input_boolean, default ON if empty)"
      default:
      selector: { entity: { domain: "input_boolean" } }
    auto_on_evening_helper:
      name: "Evening Auto-on (input_boolean, default OFF if empty)"
      default:
      selector: { entity: { domain: "input_boolean" } }

    enable_night_helper:
      name: "Night Enabled (input_boolean, default ON if empty)"
      default:
      selector: { entity: { domain: "input_boolean" } }
    auto_on_night_helper:
      name: "Night Auto-on (input_boolean, default OFF if empty)"
      default:
      selector: { entity: { domain: "input_boolean" } }

mode: "restart"
max_exceeded: "silent"

variables:
  # Materialize optional schedule inputs
  custom_schedule_enabled_input: !input custom_schedule_enabled
  custom_s1_start_input: !input custom_s1_start
  custom_s2_start_input: !input custom_s2_start
  custom_s3_start_input: !input custom_s3_start
  custom_s4_start_input: !input custom_s4_start

  # Materialize enable/auto_on helpers
  enable_morning_helper_input: !input enable_morning_helper
  auto_on_morning_helper_input: !input auto_on_morning_helper
  enable_day_helper_input: !input enable_day_helper
  auto_on_day_helper_input: !input auto_on_day_helper
  enable_evening_helper_input: !input enable_evening_helper
  auto_on_evening_helper_input: !input auto_on_evening_helper
  enable_night_helper_input: !input enable_night_helper
  auto_on_night_helper_input: !input auto_on_night_helper

  room_key_var: !input room_key
  target_lights_var: !input target_lights

  default_s1: "06:00:00"
  default_s2: "09:00:00"
  default_s3: "17:00:00"
  default_s4: "22:00:00"

  # Check per-time-window custom times
  morning_custom: >-
    {% set helper = 'input_boolean.' ~ room_key_var ~ '_morning_custom_time' %}
    {% set state_val = states(helper) %}
    {% if state_val not in ['unknown', 'unavailable', None, ''] %}
      {{ is_state(helper, 'on') }}
    {% elif custom_schedule_enabled_input is not none and custom_schedule_enabled_input != '' %}
      {{ is_state(custom_schedule_enabled_input, 'on') }}
    {% else %}
      {{ false }}
    {% endif %}
  day_custom: >-
    {% set helper = 'input_boolean.' ~ room_key_var ~ '_day_custom_time' %}
    {% set state_val = states(helper) %}
    {% if state_val not in ['unknown', 'unavailable', None, ''] %}
      {{ is_state(helper, 'on') }}
    {% elif custom_schedule_enabled_input is not none and custom_schedule_enabled_input != '' %}
      {{ is_state(custom_schedule_enabled_input, 'on') }}
    {% else %}
      {{ false }}
    {% endif %}
  evening_custom: >-
    {% set helper = 'input_boolean.' ~ room_key_var ~ '_evening_custom_time' %}
    {% set state_val = states(helper) %}
    {% if state_val not in ['unknown', 'unavailable', None, ''] %}
      {{ is_state(helper, 'on') }}
    {% elif custom_schedule_enabled_input is not none and custom_schedule_enabled_input != '' %}
      {{ is_state(custom_schedule_enabled_input, 'on') }}
    {% else %}
      {{ false }}
    {% endif %}
  night_custom: >-
    {% set helper = 'input_boolean.' ~ room_key_var ~ '_night_custom_time' %}
    {% set state_val = states(helper) %}
    {% if state_val not in ['unknown', 'unavailable', None, ''] %}
      {{ is_state(helper, 'on') }}
    {% elif custom_schedule_enabled_input is not none and custom_schedule_enabled_input != '' %}
      {{ is_state(custom_schedule_enabled_input, 'on') }}
    {% else %}
      {{ false }}
    {% endif %}

  # Check if separate weekday/weekend times are enabled
  morning_separate: >-
    {% set helper = 'input_boolean.' ~ room_key_var ~ '_morning_separate_weekday_weekend' %}
    {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
  # Check if today is a weekday (Mon-Fri) or weekend (Sat-Sun)
  is_weekday: >-
    {% set day = now().strftime('%A').lower() %}
    {{ day in ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'] }}
  
  s1_str: >-
    {% if morning_custom %}
      {% if morning_separate %}
        {% if is_weekday %}
          {% set v = states('input_datetime.' ~ room_key_var ~ '_s1_weekday_start') %}
        {% else %}
          {% set v = states('input_datetime.' ~ room_key_var ~ '_s1_weekend_start') %}
        {% endif %}
      {% else %}
        {% set v = states('input_datetime.' ~ room_key_var ~ '_s1_start') %}
      {% endif %}
      {% if v in ['unknown','unavailable',''] %}{{ default_s1 }}{% else %}{{ v }}{% endif %}
    {% elif custom_s1_start_input %}
      {% set v = states(custom_s1_start_input) %}
      {% if v in ['unknown','unavailable',''] %}{{ default_s1 }}{% else %}{{ v }}{% endif %}
    {% else %}
      {{ default_s1 }}
    {% endif %}
  day_separate: >-
    {% set helper = 'input_boolean.' ~ room_key_var ~ '_day_separate_weekday_weekend' %}
    {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
  
  s2_str: >-
    {% if day_custom %}
      {% if day_separate %}
        {% if is_weekday %}
          {% set v = states('input_datetime.' ~ room_key_var ~ '_s2_weekday_start') %}
        {% else %}
          {% set v = states('input_datetime.' ~ room_key_var ~ '_s2_weekend_start') %}
        {% endif %}
      {% else %}
        {% set v = states('input_datetime.' ~ room_key_var ~ '_s2_start') %}
      {% endif %}
      {% if v in ['unknown','unavailable',''] %}{{ default_s2 }}{% else %}{{ v }}{% endif %}
    {% elif custom_s2_start_input %}
      {% set v = states(custom_s2_start_input) %}
      {% if v in ['unknown','unavailable',''] %}{{ default_s2 }}{% else %}{{ v }}{% endif %}
    {% else %}
      {{ default_s2 }}
    {% endif %}
  evening_separate: >-
    {% set helper = 'input_boolean.' ~ room_key_var ~ '_evening_separate_weekday_weekend' %}
    {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
  
  s3_str: >-
    {% if evening_custom %}
      {% if evening_separate %}
        {% if is_weekday %}
          {% set v = states('input_datetime.' ~ room_key_var ~ '_s3_weekday_start') %}
        {% else %}
          {% set v = states('input_datetime.' ~ room_key_var ~ '_s3_weekend_start') %}
        {% endif %}
      {% else %}
        {% set helper_name = 'input_datetime.' ~ room_key_var ~ '_s3_start' %}
        {% set v = states(helper_name) %}
      {% endif %}
      {% if v in ['unknown','unavailable',''] %}{{ default_s3 }}{% else %}{{ v }}{% endif %}
    {% elif custom_s3_start_input %}
      {% set v = states(custom_s3_start_input) %}
      {% if v in ['unknown','unavailable',''] %}{{ default_s3 }}{% else %}{{ v }}{% endif %}
    {% else %}
      {{ default_s3 }}
    {% endif %}
  night_separate: >-
    {% set helper = 'input_boolean.' ~ room_key_var ~ '_night_separate_weekday_weekend' %}
    {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
  
  s4_str: >-
    {% if night_custom %}
      {% if night_separate %}
        {% if is_weekday %}
          {% set v = states('input_datetime.' ~ room_key_var ~ '_s4_weekday_start') %}
        {% else %}
          {% set v = states('input_datetime.' ~ room_key_var ~ '_s4_weekend_start') %}
        {% endif %}
      {% else %}
        {% set v = states('input_datetime.' ~ room_key_var ~ '_s4_start') %}
      {% endif %}
      {% if v in ['unknown','unavailable',''] %}{{ default_s4 }}{% else %}{{ v }}{% endif %}
    {% elif custom_s4_start_input %}
      {% set v = states(custom_s4_start_input) %}
      {% if v in ['unknown','unavailable',''] %}{{ default_s4 }}{% else %}{{ v }}{% endif %}
    {% else %}
      {{ default_s4 }}
    {% endif %}

  # Extract time portion (HH:MM) from datetime string
  # Handles formats like "19:24:00" or "2024-01-01 19:24:00"
  s1: >-
    {% set raw = s1_str %}
    {% if ' ' in raw %}{{ raw.split(' ')[-1][:5] }}{% else %}{{ raw[:5] }}{% endif %}
  s2: >-
    {% set raw = s2_str %}
    {% if ' ' in raw %}{{ raw.split(' ')[-1][:5] }}{% else %}{{ raw[:5] }}{% endif %}
  s3: >-
    {% set raw = s3_str %}
    {% if ' ' in raw %}{{ raw.split(' ')[-1][:5] }}{% else %}{{ raw[:5] }}{% endif %}
  s4: >-
    {% set raw = s4_str %}
    {% if ' ' in raw %}{{ raw.split(' ')[-1][:5] }}{% else %}{{ raw[:5] }}{% endif %}

  # Window enable/auto_on booleans with sensible defaults
  en_morning: >-
    {% if enable_morning_helper_input %}
      {{ is_state(enable_morning_helper_input, 'on') }}
    {% else %}
      {% if is_weekday %}
        {% set helper = 'input_boolean.enable_' ~ room_key_var ~ '_morning_weekday' %}
      {% else %}
        {% set helper = 'input_boolean.enable_' ~ room_key_var ~ '_morning_weekend' %}
      {% endif %}
      {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else true }}
    {% endif %}
  ao_morning: >-
    {% if auto_on_morning_helper_input %}
      {{ is_state(auto_on_morning_helper_input, 'on') }}
    {% else %}
      {% if is_weekday %}
        {% set helper = 'input_boolean.auto_on_' ~ room_key_var ~ '_morning_weekday' %}
      {% else %}
        {% set helper = 'input_boolean.auto_on_' ~ room_key_var ~ '_morning_weekend' %}
      {% endif %}
      {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
    {% endif %}
  en_day: >-
    {% if enable_day_helper_input %}
      {{ is_state(enable_day_helper_input, 'on') }}
    {% else %}
      {% if is_weekday %}
        {% set helper = 'input_boolean.enable_' ~ room_key_var ~ '_day_weekday' %}
      {% else %}
        {% set helper = 'input_boolean.enable_' ~ room_key_var ~ '_day_weekend' %}
      {% endif %}
      {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else true }}
    {% endif %}
  ao_day: >-
    {% if auto_on_day_helper_input %}
      {{ is_state(auto_on_day_helper_input, 'on') }}
    {% else %}
      {% if is_weekday %}
        {% set helper = 'input_boolean.auto_on_' ~ room_key_var ~ '_day_weekday' %}
      {% else %}
        {% set helper = 'input_boolean.auto_on_' ~ room_key_var ~ '_day_weekend' %}
      {% endif %}
      {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
    {% endif %}
  en_evening: >-
    {% if enable_evening_helper_input %}
      {{ is_state(enable_evening_helper_input, 'on') }}
    {% else %}
      {% if is_weekday %}
        {% set helper = 'input_boolean.enable_' ~ room_key_var ~ '_evening_weekday' %}
      {% else %}
        {% set helper = 'input_boolean.enable_' ~ room_key_var ~ '_evening_weekend' %}
      {% endif %}
      {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else true }}
    {% endif %}
  ao_evening: >-
    {% if auto_on_evening_helper_input %}
      {{ is_state(auto_on_evening_helper_input, 'on') }}
    {% else %}
      {% if is_weekday %}
        {% set helper = 'input_boolean.auto_on_' ~ room_key_var ~ '_evening_weekday' %}
      {% else %}
        {% set helper = 'input_boolean.auto_on_' ~ room_key_var ~ '_evening_weekend' %}
      {% endif %}
      {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
    {% endif %}
  en_night: >-
    {% if enable_night_helper_input %}
      {{ is_state(enable_night_helper_input, 'on') }}
    {% else %}
      {% if is_weekday %}
        {% set helper = 'input_boolean.enable_' ~ room_key_var ~ '_night_weekday' %}
      {% else %}
        {% set helper = 'input_boolean.enable_' ~ room_key_var ~ '_night_weekend' %}
      {% endif %}
      {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else true }}
    {% endif %}
  ao_night: >-
    {% if auto_on_night_helper_input %}
      {{ is_state(auto_on_night_helper_input, 'on') }}
    {% else %}
      {% if is_weekday %}
        {% set helper = 'input_boolean.auto_on_' ~ room_key_var ~ '_night_weekday' %}
      {% else %}
        {% set helper = 'input_boolean.auto_on_' ~ room_key_var ~ '_night_weekend' %}
      {% endif %}
      {{ is_state(helper, 'on') if states(helper) not in ['unknown', 'unavailable'] else false }}
    {% endif %}

trigger:
  # Use time_pattern to check every minute at :00 seconds, but only fire when time matches a slot
  - platform: "time_pattern"
    seconds: "0"
    id: "minute_check"

condition:
  # Only proceed if current time matches one of the slot times AND that slot is enabled AND current day is enabled
  - condition: template
    value_template: >-
      {% set now_hm = now().strftime('%H:%M') %}
      {% set current_day = now().strftime('%A').lower() %}
      {% set day_helper_morning = 'input_boolean.' ~ room_key_var ~ '_morning_' ~ current_day %}
      {% set day_helper_day = 'input_boolean.' ~ room_key_var ~ '_day_' ~ current_day %}
      {% set day_helper_evening = 'input_boolean.' ~ room_key_var ~ '_evening_' ~ current_day %}
      {% set day_helper_night = 'input_boolean.' ~ room_key_var ~ '_night_' ~ current_day %}
      {% set day_enabled_morning = is_state(day_helper_morning, 'on') if states(day_helper_morning) not in ['unknown', 'unavailable'] else true %}
      {% set day_enabled_day = is_state(day_helper_day, 'on') if states(day_helper_day) not in ['unknown', 'unavailable'] else true %}
      {% set day_enabled_evening = is_state(day_helper_evening, 'on') if states(day_helper_evening) not in ['unknown', 'unavailable'] else true %}
      {% set day_enabled_night = is_state(day_helper_night, 'on') if states(day_helper_night) not in ['unknown', 'unavailable'] else true %}
      {% set matches_morning = now_hm == s1 and en_morning | bool and day_enabled_morning %}
      {% set matches_day = now_hm == s2 and en_day | bool and day_enabled_day %}
      {% set matches_evening = now_hm == s3 and en_evening | bool and day_enabled_evening %}
      {% set matches_night = now_hm == s4 and en_night | bool and day_enabled_night %}
      {{ matches_morning or matches_day or matches_evening or matches_night }}

action:
  - variables:
      # Determine which slot fired
      fired_slot: >-
        {% set now_hm = now().strftime('%H:%M') %}
        {% if now_hm == s1 and en_morning | bool %}morning
        {% elif now_hm == s2 and en_day | bool %}day
        {% elif now_hm == s3 and en_evening | bool %}evening
        {% elif now_hm == s4 and en_night | bool %}night
        {% else %}none{% endif %}
      
      # Extract target entity IDs safely
      _fb_var: >-
        {% if target_lights_var is mapping and 'entity_id' in target_lights_var %}
          {{ target_lights_var.entity_id }}
        {% elif target_lights_var is mapping %}
          {{ '' }}
        {% else %}
          {{ target_lights_var }}
        {% endif %}
      
      # Get enable/auto_on for the fired slot
      slot_enabled: >-
        {% if fired_slot == 'morning' %}{{ en_morning | bool }}
        {% elif fired_slot == 'day' %}{{ en_day | bool }}
        {% elif fired_slot == 'evening' %}{{ en_evening | bool }}
        {% elif fired_slot == 'night' %}{{ en_night | bool }}
        {% else %}false{% endif %}
      
      slot_auto_on: >-
        {% if fired_slot == 'morning' %}{{ ao_morning | bool }}
        {% elif fired_slot == 'day' %}{{ ao_day | bool }}
        {% elif fired_slot == 'evening' %}{{ ao_evening | bool }}
        {% elif fired_slot == 'night' %}{{ ao_night | bool }}
        {% else %}false{% endif %}

  # Call the script which handles: turn on lights if off (if auto_on), apply scene to lights that are on
  - service: "script.scheduled_light_on"
    data_template:
      fallback_lights: "{{ _fb_var }}"
      timer_mode: true
      auto_on: "{{ slot_auto_on }}"
      custom_schedule_enabled: "{{ custom_schedule_enabled_input if custom_schedule_enabled_input and custom_schedule_enabled_input != '' and custom_schedule_enabled_input is not none else '' }}"
      custom_s1_start: "{{ custom_s1_start_input if custom_s1_start_input and custom_s1_start_input != '' and custom_s1_start_input is not none else '' }}"
      custom_s2_start: "{{ custom_s2_start_input if custom_s2_start_input and custom_s2_start_input != '' and custom_s2_start_input is not none else '' }}"
      custom_s3_start: "{{ custom_s3_start_input if custom_s3_start_input and custom_s3_start_input != '' and custom_s3_start_input is not none else '' }}"
      custom_s4_start: "{{ custom_s4_start_input if custom_s4_start_input and custom_s4_start_input != '' and custom_s4_start_input is not none else '' }}"

