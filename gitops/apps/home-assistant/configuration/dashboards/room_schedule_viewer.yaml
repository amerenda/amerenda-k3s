views:
  - title: Room Schedule Viewer
    path: room-schedule-viewer
    cards:
      # Selectors
      - type: vertical-stack
        cards:
          - type: entities
            title: Select Room
            entities:
              - entity: input_select.room_selector
                name: Room

      # Active Scene Status Card
      - type: markdown
        title: Current Status
        content: |
          {% set room = states('input_select.room_selector') %}
          {% if room and room != 'unknown' and room != 'unavailable' %}
            
            {# --- Resolve Current Slot --- #}
            {% set use_custom_schedule = is_state('input_boolean.' ~ room ~ '_custom_schedule', 'on') %}
            
            {# Global Schedule States #}
            {% set global_morning = is_state('schedule.scenes_morning', 'on') %}
            {% set global_day = is_state('schedule.scenes_day', 'on') %}
            {% set global_evening = is_state('schedule.scenes_evening', 'on') %}
            {% set global_night = is_state('schedule.scenes_night', 'on') %}
            
            {% if use_custom_schedule %}
               {# Custom Timestamp Logic #}
               {% set s1 = states('input_datetime.' ~ room ~ '_s1_start') %}
               {% set s2 = states('input_datetime.' ~ room ~ '_s2_start') %}
               {% set s3 = states('input_datetime.' ~ room ~ '_s3_start') %}
               {% set s4 = states('input_datetime.' ~ room ~ '_s4_start') %}
               
               {# Fallback defaults if custom time not set #}
               {% set s1 = s1 if s1 not in ['unknown','unavailable'] else '06:30:00' %}
               {% set s2 = s2 if s2 not in ['unknown','unavailable'] else '10:30:00' %}
               {% set s3 = s3 if s3 not in ['unknown','unavailable'] else '18:00:00' %}
               {% set s4 = s4 if s4 not in ['unknown','unavailable'] else '23:00:00' %}

               {% set now_ts = as_timestamp(now()) %}
               {% set s1_ts = as_timestamp(today_at(s1)) %}
               {% set s2_ts = as_timestamp(today_at(s2)) %}
               {% set s3_ts = as_timestamp(today_at(s3)) %}
               {% set s4_ts = as_timestamp(today_at(s4)) %}
               
               {% if now_ts >= s1_ts and now_ts < s2_ts %}
                 {% set current_slot = 'morning' %}
               {% elif now_ts >= s2_ts and now_ts < s3_ts %}
                 {% set current_slot = 'day' %}
               {% elif now_ts >= s3_ts and now_ts < s4_ts %}
                 {% set current_slot = 'evening' %}
               {% else %}
                 {% set current_slot = 'night' %}
               {% endif %}
               {% set schedule_source = "Custom Room Schedule" %}
            {% else %}
               {# Global Schedule Entity Logic #}
               {% if global_night %}{% set current_slot = 'night' %}
               {% elif global_evening %}{% set current_slot = 'evening' %}
               {% elif global_day %}{% set current_slot = 'day' %}
               {% elif global_morning %}{% set current_slot = 'morning' %}
               {% else %}{% set current_slot = 'night' %}{% endif %}
               {% set schedule_source = "Global Schedule" %}
            {% endif %}

            {# --- Manual Override Check --- #}
            {% set scene_cycle_helper = 'input_select.' ~ room ~ '_scene_cycle' %}
            {% set active_scene_select = states(scene_cycle_helper) %}
            {% if active_scene_select and active_scene_select in ['morning', 'day', 'evening', 'night'] and active_scene_select != current_slot %}
               {% set display_slot = active_scene_select %}
               {% set status_msg = "Manual Override Active" %}
            {% else %}
               {% set display_slot = current_slot %}
               {% set status_msg = "Following Schedule" %}
            {% endif %}

            ### **{{ display_slot|title }} Scene Active**
            
            *{{ status_msg }} ({{ schedule_source }})*
            
            ---
            #### Schedule Configuration (Today)
            
            | Slot | Start Time | Auto-On Mode | Motion | Auto-Off |
            |------|------------|--------------|--------|----------|
            {% for slot in ['morning', 'day', 'evening', 'night'] %}
              {# Resolve Start Time #}
              {% set start_time_display = "N/A" %}
              {% if use_custom_schedule and is_state('input_boolean.' ~ room ~ '_' ~ slot ~ '_custom_time', 'on') %}
                 {% set idx = loop.index %}
                 {% set custom_time = states('input_datetime.' ~ room ~ '_s' ~ idx ~ '_start') %}
                 {% set start_time_display = custom_time[:5] if custom_time else "Error" %}
              {% else %}
                 {# Attempt to get from Global Schedule Entity #}
                 {% set today = now().strftime('%A').lower() %}
                 {% set sched_entity = 'schedule.scenes_' ~ slot %}
                 {% set blocks = state_attr(sched_entity, today) %}
                 {% if blocks and blocks | length > 0 %}
                    {# Handle multiple blocks (e.g. night split) - show first one #}
                    {% set start_time_display = blocks[0].from %}
                 {% else %}
                    {% set start_time_display = "-" %}
                 {% endif %}
              {% endif %}
              
              {# Resolve Auto-On Mode #}
              {% set auto_on_mode = states('input_select.' ~ room ~ '_' ~ slot ~ '_auto_on_mode') %}
              
              {# Resolve Motion #}
              {% set motion_en = states('input_boolean.' ~ room ~ '_' ~ slot ~ '_motion_enabled') %}
              {% set motion_icon = '✓' if motion_en == 'on' else '✗' %}
              
              {# Resolve Auto-Off #}
              {% set auto_off = states('input_number.motion_auto_off_' ~ room ~ '_' ~ slot) %}
              {% set auto_off_display = (auto_off | int) ~ "m" if auto_off not in ['unknown','unavailable'] else "-" %}
              
              | {{ slot|title }} | {{ start_time_display }} | {{ auto_on_mode }} | {{ motion_icon }} | {{ auto_off_display }} |
            {% endfor %}

          {% else %}
            Please select a room above.
          {% endif %}

      # Manual Scene Control Buttons - Conditional cards per room
      - type: conditional
        conditions:
          - entity: input_select.room_selector
            state: bathroom
        card:
          type: horizontal-stack
          cards:
                - type: button
                  name: Morning
                  icon: mdi:weather-sunset-up
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.bathroom_morning
                      helper_entity: input_select.bathroom_scene_cycle
                      slot_name: morning
                  show_state: false
                - type: button
                  name: Day
                  icon: mdi:weather-sunny
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.bathroom_day
                      helper_entity: input_select.bathroom_scene_cycle
                      slot_name: day
                  show_state: false
                - type: button
                  name: Evening
                  icon: mdi:weather-sunset-down
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.bathroom_evening
                      helper_entity: input_select.bathroom_scene_cycle
                      slot_name: evening
                  show_state: false
                - type: button
                  name: Night
                  icon: mdi:weather-night
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.bathroom_night
                      helper_entity: input_select.bathroom_scene_cycle
                      slot_name: night
                  show_state: false

      - type: conditional
        conditions:
          - entity: input_select.room_selector
            state: bedroom
        card:
          type: horizontal-stack
          cards:
                - type: button
                  name: Morning
                  icon: mdi:weather-sunset-up
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.bedroom_morning
                      helper_entity: input_select.bedroom_scene_cycle
                      slot_name: morning
                  show_state: false
                - type: button
                  name: Day
                  icon: mdi:weather-sunny
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.bedroom_day
                      helper_entity: input_select.bedroom_scene_cycle
                      slot_name: day
                  show_state: false
                - type: button
                  name: Evening
                  icon: mdi:weather-sunset-down
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.bedroom_evening
                      helper_entity: input_select.bedroom_scene_cycle
                      slot_name: evening
                  show_state: false
                - type: button
                  name: Night
                  icon: mdi:weather-night
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.bedroom_night
                      helper_entity: input_select.bedroom_scene_cycle
                      slot_name: night
                  show_state: false

      - type: conditional
        conditions:
          - entity: input_select.room_selector
            state: hallway
        card:
          type: horizontal-stack
          cards:
                - type: button
                  name: Morning
                  icon: mdi:weather-sunset-up
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.hallway_morning
                      helper_entity: input_select.hallway_scene_cycle
                      slot_name: morning
                  show_state: false
                - type: button
                  name: Day
                  icon: mdi:weather-sunny
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.hallway_day
                      helper_entity: input_select.hallway_scene_cycle
                      slot_name: day
                  show_state: false
                - type: button
                  name: Evening
                  icon: mdi:weather-sunset-down
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.hallway_evening
                      helper_entity: input_select.hallway_scene_cycle
                      slot_name: evening
                  show_state: false
                - type: button
                  name: Night
                  icon: mdi:weather-night
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.hallway_night
                      helper_entity: input_select.hallway_scene_cycle
                      slot_name: night
                  show_state: false

      - type: conditional
        conditions:
          - entity: input_select.room_selector
            state: kitchen
        card:
          type: horizontal-stack
          cards:
                - type: button
                  name: Morning
                  icon: mdi:weather-sunset-up
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.kitchen_morning
                      helper_entity: input_select.kitchen_scene_cycle
                      slot_name: morning
                  show_state: false
                - type: button
                  name: Day
                  icon: mdi:weather-sunny
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.kitchen_day
                      helper_entity: input_select.kitchen_scene_cycle
                      slot_name: day
                  show_state: false
                - type: button
                  name: Evening
                  icon: mdi:weather-sunset-down
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.kitchen_evening
                      helper_entity: input_select.kitchen_scene_cycle
                      slot_name: evening
                  show_state: false
                - type: button
                  name: Night
                  icon: mdi:weather-night
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.kitchen_night
                      helper_entity: input_select.kitchen_scene_cycle
                      slot_name: night
                  show_state: false

      - type: conditional
        conditions:
          - entity: input_select.room_selector
            state: living_room
        card:
          type: horizontal-stack
          cards:
                - type: button
                  name: Morning
                  icon: mdi:weather-sunset-up
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.living_room_morning
                      helper_entity: input_select.living_room_scene_cycle
                      slot_name: morning
                  show_state: false
                - type: button
                  name: Day
                  icon: mdi:weather-sunny
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.living_room_day
                      helper_entity: input_select.living_room_scene_cycle
                      slot_name: day
                  show_state: false
                - type: button
                  name: Evening
                  icon: mdi:weather-sunset-down
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.living_room_evening
                      helper_entity: input_select.living_room_scene_cycle
                      slot_name: evening
                  show_state: false
                - type: button
                  name: Night
                  icon: mdi:weather-night
                  tap_action:
                    action: call-service
                    service: script.activate_scene_with_helper
                    service_data:
                      scene_entity: scene.living_room_night
                      helper_entity: input_select.living_room_scene_cycle
                      slot_name: night
                  show_state: false
