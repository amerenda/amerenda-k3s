strategy:
  type: custom:mushroom-strategy
  options:
    # Hide unavailable binary sensors (camera privacy mode)
    card_options:
      # Person detection sensors
      binary_sensor.living_room_person:
        hidden: "{{ is_state('binary_sensor.living_room_person', 'unavailable') }}"
      binary_sensor.bedroom_person:
        hidden: "{{ is_state('binary_sensor.bedroom_person', 'unavailable') }}"
      # Animal detection sensors
      binary_sensor.living_room_animal:
        hidden: "{{ is_state('binary_sensor.living_room_animal', 'unavailable') }}"
      binary_sensor.bedroom_animal:
        hidden: "{{ is_state('binary_sensor.bedroom_animal', 'unavailable') }}"
      binary_sensor.bedroom_baby_crying:
        hidden: true
      binary_sensor.living_room_baby_crying:
        hidden: true
      # Hide camera cards when privacy mode is enabled
      camera.bedroom_fluent:
        hidden: "{{ is_state('switch.bedroom_privacy_mode', 'on') }}"
      camera.living_room_fluent:
        hidden: "{{ is_state('switch.living_room_privacy_mode', 'on') }}"
      # Hide light groups that only contain one member (to prevent duplicates)
      # Example: light.living_room group containing only light.fixture
      # Try multiple methods to check group membership since different group types store members differently
      light.living_room:
        hidden: >
          {% set attr_entities = state_attr('light.living_room', 'entity_id') | default([]) %}
          {% set expanded = expand('light.living_room') | list %}
          {% set expanded_ids = expanded | map(attribute='entity_id') | list %}
          {# Check if expanded list excludes the group itself and has only 1 member #}
          {% set members_only = expanded_ids | reject('eq', 'light.living_room') | list %}
          {% if attr_entities is iterable and attr_entities is not string and attr_entities | list | length > 0 %}
            {{ (attr_entities | list | length) == 1 }}
          {% elif members_only | length == 1 %}
            true
          {% elif expanded | length == 2 %}
            {# expand() includes the group itself, so 2 items means group + 1 member #}
            true
          {% else %}
            false
          {% endif %}
      light.bathroom:
        hidden: >
          {% set attr_entities = state_attr('light.bathroom', 'entity_id') | default([]) %}
          {% set expanded = expand('light.bathroom') | list %}
          {% if attr_entities is iterable and attr_entities is not string and attr_entities | list | length > 0 %}
            {{ (attr_entities | list | length) == 1 }}
          {% elif expanded | length > 1 %}
            {{ expanded | length == 2 }}
          {% else %}
            false
          {% endif %}
      light.hallway:
        hidden: >
          {% set attr_entities = state_attr('light.hallway', 'entity_id') | default([]) %}
          {% set expanded = expand('light.hallway') | list %}
          {% set expanded_ids = expanded | map(attribute='entity_id') | list %}
          {# Check if expanded list excludes the group itself and has only 1 member #}
          {% set members_only = expanded_ids | reject('eq', 'light.hallway') | list %}
          {% if attr_entities is iterable and attr_entities is not string and attr_entities | list | length > 0 %}
            {{ (attr_entities | list | length) == 1 }}
          {% elif members_only | length == 1 %}
            true
          {% elif expanded | length == 2 %}
            {# expand() includes the group itself, so 2 items means group + 1 member #}
            true
          {% else %}
            false
          {% endif %}
      light.bedroom:
        hidden: >
          {% set group_entities = state_attr('light.bedroom', 'entity_id') | default([]) %}
          {% if group_entities is iterable and group_entities is not string %}
            {{ (group_entities | list | length) == 1 }}
          {% else %}
            false
          {% endif %}
      light.kitchen:
        hidden: >
          {% set group_entities = state_attr('light.kitchen', 'entity_id') | default([]) %}
          {% if group_entities is iterable and group_entities is not string %}
            {{ (group_entities | list | length) == 1 }}
          {% else %}
            false
          {% endif %}

    # Domain-level filtering for binary sensors
    domains:
      binary_sensor:
        exclude:
          entities:
            # Exclude unavailable binary sensors from areas
            - filter:
                state: unavailable
      # Domain-level filtering for lights - hide groups that only contain one member
      # Note: This uses template filter which may not work for all group types
      # The card_options approach above should handle most cases
      light:
        exclude:
          entities:
            # Exclude light groups that only have one member
            - filter:
                entity_id: "light.living_room"
                template: >
                  {% set group_entities = state_attr('light.living_room', 'entity_id') | default([]) %}
                  {% if group_entities is iterable and group_entities is not string %}
                    {{ (group_entities | list | length) == 1 }}
                  {% else %}
                    {{ false }}
                  {% endif %}
            - filter:
                entity_id: "light.hallway"
                template: >
                  {% set group_entities = state_attr('light.hallway', 'entity_id') | default([]) %}
                  {% if group_entities is iterable and group_entities is not string %}
                    {{ (group_entities | list | length) == 1 }}
                  {% else %}
                    {{ false }}
                  {% endif %}

    # Quick access cards (between greeting and area cards)
    quick_access_cards:
      - type: custom:mushroom-title-card
        title: Quick Access
      - type: conditional
        conditions:
          - condition: state
            entity: weather.home
            state: available
        card:
          type: custom:mushroom-weather-card
          entity: weather.home
          show_temperature: true
          show_conditions: true
          primary_info: state
          secondary_info: temperature
      # System Status - commented out as it requires System Health integration
      # - type: entities
      #   title: System Status
      #   entities:
      #     - entity: sensor.home_assistant_version
      #       name: Home Assistant
      #       secondary_info: state
      #     - entity: binary_sensor.ha_system_health
      #       name: System Health
      #       secondary_info: state

    # Custom chips on home view
    chips:
      extra_chips:
          # System Health chip - commented out as it requires System Health integration
          # - type: entity
          #   entity: binary_sensor.ha_system_health
          #   icon: mdi:heart-pulse
          #   icon_color: |
          #     {% if is_state('binary_sensor.ha_system_health', 'on') %}
          #       green
          #     {% else %}
          #       red
          #     {% endif %}
          #   content_info: none
          #   tap_action:
          #     action: navigate
          #     navigation_path: /config/info
        - type: entity
          entity: sun.sun
          icon: mdi:weather-sunset
          content_info: elevation
          tap_action:
            action: navigate
            navigation_path: /config/energy
        - type: conditional
          conditions:
            - condition: state
              entity: alarm_control_panel.home_alarm
              state: available
          chip:
            type: entity
            entity: alarm_control_panel.home_alarm
            icon: mdi:shield-home
            icon_color: |
              {% if is_state('alarm_control_panel.home_alarm', 'armed_away') %}
                red
              {% elif is_state('alarm_control_panel.home_alarm', 'armed_home') %}
                orange
              {% else %}
                green
              {% endif %}
            content_info: none
            tap_action:
              action: toggle

    # Extra cards (below area cards)
    extra_cards:
      - type: custom:mushroom-title-card
        title: Additional Information
      - type: grid
        square: false
        columns: 2
        cards:
          # Energy monitoring - commented out as not available yet
          # - type: entities
          #   title: Energy
          #   entities:
          #     - entity: sensor.energy_consumption
          #       name: Energy Usage
          #       icon: mdi:lightning-bolt
          #       secondary_info: last-updated
          #     - entity: sensor.power_consumption
          #       name: Current Power
          #       icon: mdi:flash
          #       secondary_info: last-updated
          - type: entities
            title: Environment
            entities:
              # Temperature from midea_ac_lan integration
              - entity: >
                  {% set midea_entities = states.climate | selectattr('entity_id', 'match', '.*midea.*') | map(attribute='entity_id') | list %}
                  {% if midea_entities | length > 0 %}
                    {{ midea_entities[0] }}
                  {% else %}
                    sensor.temperature
                  {% endif %}
                name: Temperature
                icon: mdi:thermometer
                secondary_info: state
              - entity: sensor.humidity
                name: Humidity
                icon: mdi:water-percent
                secondary_info: last-updated

    # View customizations
    views:
      # Customize default view
      default:
        title: Home
        icon: mdi:home
        path: home

