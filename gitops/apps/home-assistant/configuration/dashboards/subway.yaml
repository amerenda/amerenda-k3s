views:
  - title: Overview
    icon: mdi:train
    cards:
      - type: vertical-stack
        cards:
          # --- ATLANTIC AV ---
          - type: custom:auto-entities
            card:
              type: entities
              title: Atlantic Av-Barclays Ctr
              show_header_toggle: false
            filter:
              template: |
                {% set ns = namespace(north=[], south=[]) %}
                {% for state in states.sensor -%}
                  {%- if state.attributes.friendly_name is defined and ('Atlantic Av' in state.attributes.friendly_name or 'Barclays' in state.attributes.friendly_name) and state.state not in ['unavailable', 'unknown'] -%}
                    {%- set headsign = state.attributes.headsign | default('Unknown') -%}
                    {%- if headsign is search('Manhattan|Astoria|Forest Hills|Jamaica|96 St|205 St|Wakefield|Harlem|Ditmars|Midtown|Bedford|168 St|57 St') -%}
                      {%- set ns.north = ns.north + [state] -%}
                    {%- else -%}
                      {%- set ns.south = ns.south + [state] -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor %}
                [
                  { "type": "section", "label": "Northbound" },
                  {% for state in ns.north -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                  { "type": "section", "label": "Southbound" },
                  {% for state in ns.south -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                ]
            sort:
              method: name

          # --- BERGEN ST ---
          - type: custom:auto-entities
            card:
              type: entities
              title: Bergen St
              show_header_toggle: false
            filter:
              template: |
                {% set ns = namespace(north=[], south=[]) %}
                {% for state in states.sensor -%}
                  {%- if state.attributes.friendly_name is defined and 'Bergen St' in state.attributes.friendly_name and state.state not in ['unavailable', 'unknown'] -%}
                    {%- set headsign = state.attributes.headsign | default('Unknown') -%}
                    {%- if headsign is search('Manhattan|Astoria|Forest Hills|Jamaica|96 St|205 St|Wakefield|Harlem|Ditmars|Midtown|Bedford|168 St|57 St|Court Sq') -%}
                      {%- set ns.north = ns.north + [state] -%}
                    {%- else -%}
                      {%- set ns.south = ns.south + [state] -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor %}
                [
                  { "type": "section", "label": "Northbound" },
                  {% for state in ns.north -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                  { "type": "section", "label": "Southbound" },
                  {% for state in ns.south -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                ]
            sort:
              method: name

          # --- FULTON ST ---
          - type: custom:auto-entities
            card:
              type: entities
              title: Fulton St
              show_header_toggle: false
            filter:
              template: |
                {% set ns = namespace(north=[], south=[]) %}
                {% for state in states.sensor -%}
                  {%- if state.attributes.friendly_name is defined and 'Fulton St' in state.attributes.friendly_name and state.state not in ['unavailable', 'unknown'] -%}
                    {%- set headsign = state.attributes.headsign | default('Unknown') -%}
                    {%- if headsign is search('Manhattan|Astoria|Forest Hills|Jamaica|96 St|205 St|Wakefield|Harlem|Ditmars|Midtown|Bedford|168 St|57 St|Court Sq') -%}
                      {%- set ns.north = ns.north + [state] -%}
                    {%- else -%}
                      {%- set ns.south = ns.south + [state] -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor %}
                [
                  { "type": "section", "label": "Northbound" },
                  {% for state in ns.north -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                  { "type": "section", "label": "Southbound" },
                  {% for state in ns.south -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                ]
            sort:
              method: name

          # --- LAFAYETTE AV ---
          - type: custom:auto-entities
            card:
              type: entities
              title: Lafayette Av
              show_header_toggle: false
            filter:
              template: |
                {% set ns = namespace(north=[], south=[]) %}
                {% for state in states.sensor -%}
                  {%- if state.attributes.friendly_name is defined and 'Lafayette Av' in state.attributes.friendly_name and state.state not in ['unavailable', 'unknown'] -%}
                    {%- set headsign = state.attributes.headsign | default('Unknown') -%}
                    {%- if headsign is search('Manhattan|Astoria|Forest Hills|Jamaica|96 St|205 St|Wakefield|Harlem|Ditmars|Midtown|Bedford|168 St|57 St') -%}
                      {%- set ns.north = ns.north + [state] -%}
                    {%- else -%}
                      {%- set ns.south = ns.south + [state] -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor %}
                [
                  { "type": "section", "label": "Northbound" },
                  {% for state in ns.north -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                  { "type": "section", "label": "Southbound" },
                  {% for state in ns.south -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                ]
            sort:
              method: name

          # --- 57 ST ---
          - type: custom:auto-entities
            card:
              type: entities
              title: 57 St-7 Av
              show_header_toggle: false
            filter:
              template: |
                {% set ns = namespace(north=[], south=[]) %}
                {% for state in states.sensor -%}
                  {%- if state.attributes.friendly_name is defined and '57 St' in state.attributes.friendly_name and state.state not in ['unavailable', 'unknown'] -%}
                    {%- set headsign = state.attributes.headsign | default('Unknown') -%}
                    {%- if headsign is search('Manhattan|Astoria|Forest Hills|Jamaica|96 St|205 St|Wakefield|Harlem|Ditmars|Midtown|Bedford|168 St|57 St') -%}
                      {%- set ns.north = ns.north + [state] -%}
                    {%- else -%}
                      {%- set ns.south = ns.south + [state] -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor %}
                [
                  { "type": "section", "label": "Northbound" },
                  {% for state in ns.north -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                  { "type": "section", "label": "Southbound" },
                  {% for state in ns.south -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ state.attributes.headsign }}",
                      "secondary_info": "last-updated"
                    },
                  {%- endfor %}
                ]
            sort:
              method: name

  - title: Morning Commute
    icon: mdi:weather-sunset-up
    cards:
      - type: custom:auto-entities
        card:
          type: entities
          title: Morning Commute (Atlantic Av - N/Q/D)
          show_header_toggle: false
        filter:
          template: |
            [
              {% for state in states.sensor -%}
                {%- if state.attributes.friendly_name is defined and ('Atlantic Av' in state.attributes.friendly_name or 'Barclays' in state.attributes.friendly_name) and state.attributes.route_id in ['N', 'Q', 'D'] and state.state not in ['unavailable', 'unknown'] -%}
                  {%- set headsign = state.attributes.headsign | default('Unknown') -%}
                  {%- if headsign is search('Manhattan|Astoria|Forest Hills|Jamaica|96 St|205 St|Wakefield|Harlem|Ditmars|Midtown|Bedford|168 St|57 St') -%}
                  {
                    "entity": "{{ state.entity_id }}",
                    "name": "{{ state.attributes.route_id }} to {{ headsign }}",
                    "secondary_info": "last-updated"
                  },
                  {%- endif -%}
                {%- endif -%}
              {%- endfor %}
            ]
        sort:
          method: state
          numeric: true

  - title: Evening Commute
    icon: mdi:weather-night
    cards:
      - type: custom:auto-entities
        card:
          type: entities
          title: Evening Commute (57 St - N/Q/R/W)
          show_header_toggle: false
        filter:
          template: |
            [
              {% for state in states.sensor -%}
                {%- if state.attributes.friendly_name is defined and '57 St' in state.attributes.friendly_name and state.attributes.route_id in ['N', 'Q', 'R', 'W'] and state.state not in ['unavailable', 'unknown'] -%}
                  {%- set headsign = state.attributes.headsign | default('Unknown') -%}
                  {%- if not headsign is search('Manhattan|Astoria|Forest Hills|Jamaica|96 St|205 St|Wakefield|Harlem|Ditmars|Midtown|Bedford|168 St|57 St') -%}
                  {
                    "entity": "{{ state.entity_id }}",
                    "name": "{{ state.attributes.route_id }} to {{ headsign }}",
                    "secondary_info": "last-updated"
                  },
                  {%- endif -%}
                {%- endif -%}
              {%- endfor %}
            ]
        sort:
          method: state
          numeric: true

  - title: Dynamic
    icon: mdi:map-marker-radius
    cards:
      - type: conditional
        conditions:
          - entity: device_tracker.pixel_9_pro_xl
            state_not: "work"
        card:
          type: custom:auto-entities
          card:
            type: entities
            title: To Work (Atlantic Av - N/Q/D)
            icon: mdi:briefcase
            show_header_toggle: false
          filter:
            template: |
              [
                {% for state in states.sensor -%}
                  {%- if state.attributes.friendly_name is defined and ('Atlantic Av' in state.attributes.friendly_name or 'Barclays' in state.attributes.friendly_name) and state.attributes.route_id in ['N', 'Q', 'D'] and state.state not in ['unavailable', 'unknown'] -%}
                    {%- set headsign = state.attributes.headsign | default('Unknown') -%}
                    {%- if headsign is search('Manhattan|Astoria|Forest Hills|Jamaica|96 St|205 St|Wakefield|Harlem|Ditmars|Midtown|Bedford|168 St|57 St') -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ headsign }}",
                      "secondary_info": "last-updated"
                    },
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor %}
              ]
          sort:
            method: state
            numeric: true

      - type: conditional
        conditions:
          - entity: device_tracker.pixel_9_pro_xl
            state: "work"
        card:
          type: custom:auto-entities
          card:
            type: entities
            title: To Home (57 St - N/Q/R/W)
            icon: mdi:home
            show_header_toggle: false
          filter:
            template: |
              [
                {% for state in states.sensor -%}
                  {%- if state.attributes.friendly_name is defined and '57 St' in state.attributes.friendly_name and state.attributes.route_id in ['N', 'Q', 'R', 'W'] and state.state not in ['unavailable', 'unknown'] -%}
                    {%- set headsign = state.attributes.headsign | default('Unknown') -%}
                    {%- if not headsign is search('Manhattan|Astoria|Forest Hills|Jamaica|96 St|205 St|Wakefield|Harlem|Ditmars|Midtown|Bedford|168 St|57 St') -%}
                    {
                      "entity": "{{ state.entity_id }}",
                      "name": "{{ state.attributes.route_id }} to {{ headsign }}",
                      "secondary_info": "last-updated"
                    },
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor %}
              ]
          sort:
            method: state
            numeric: true
