views:
  - title: Light Control
    path: light-control
    cards:
      - type: vertical-stack
        cards:
          # Room selector
          - type: entities
            title: Select Room
            entities:
              - entity: input_select.room_selector
                name: Room

          # Dynamic Room Info
          - type: markdown
            title: Room Lighting Control
            content: |
              {% set room = states('input_select.room_selector') %}
              {% if room and room != 'unknown' and room != 'unavailable' %}
                ### {{ room|replace('_',' ')|title }} Lighting
                
                Use the controls below to:
                - Turn all room lights on/off
                - Adjust individual lights
                - Create a scene from current light states
              {% else %}
                Please select a room above.
              {% endif %}

          # Room Group Control Buttons - dynamically discover lights per room
          - type: entities
            title: Room Controls
            entities:
              - type: button
                name: >
                  {% set room = states('input_select.room_selector') %}
                  {% if room and room != 'unknown' and room != 'unavailable' %}
                    All {{ room | replace('_', ' ') | title }} Lights On
                  {% else %}
                    All Lights On
                  {% endif %}
                icon: mdi:lightbulb-group
                tap_action:
                  action: call-service
                  service: light.turn_on
                  service_data:
                    entity_id: >
                      {% set room = states('input_select.room_selector') %}
                      {% if room and room != 'unknown' and room != 'unavailable' %}
                        {% set room_key = room %}
                        {% set all_lights = states.light | map(attribute='entity_id') | list %}
                        {% set room_lights = [] %}
                        {% if room_key == 'hallway' %}
                          {% for light_id in ['light.hallway', 'light.entrance_lights'] %}
                            {% if light_id in all_lights %}
                              {% set _ = room_lights.append(light_id) %}
                            {% endif %}
                          {% endfor %}
                        {% else %}
                          {% set main_light = 'light.' ~ room_key %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room_key ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {% if numbered_lights | length == 1 and main_light in all_lights %}
                            {% set _ = room_lights.append(numbered_lights[0]) %}
                          {% elif numbered_lights | length > 1 %}
                            {% for light_id in numbered_lights %}
                              {% set _ = room_lights.append(light_id) %}
                            {% endfor %}
                          {% elif main_light in all_lights %}
                            {% set _ = room_lights.append(main_light) %}
                          {% else %}
                            {% for light_id in numbered_lights %}
                              {% set _ = room_lights.append(light_id) %}
                            {% endfor %}
                          {% endif %}
                        {% endif %}
                        {{ room_lights }}
                      {% else %}
                        []
                      {% endif %}
              - type: button
                name: >
                  {% set room = states('input_select.room_selector') %}
                  {% if room and room != 'unknown' and room != 'unavailable' %}
                    All {{ room | replace('_', ' ') | title }} Lights Off
                  {% else %}
                    All Lights Off
                  {% endif %}
                icon: mdi:lightbulb-group-off
                tap_action:
                  action: call-service
                  service: light.turn_off
                  service_data:
                    entity_id: >
                      {% set room = states('input_select.room_selector') %}
                      {% if room and room != 'unknown' and room != 'unavailable' %}
                        {% set room_key = room %}
                        {% set all_lights = states.light | map(attribute='entity_id') | list %}
                        {% set room_lights = [] %}
                        {% if room_key == 'hallway' %}
                          {% for light_id in ['light.hallway', 'light.entrance_lights'] %}
                            {% if light_id in all_lights %}
                              {% set _ = room_lights.append(light_id) %}
                            {% endif %}
                          {% endfor %}
                        {% else %}
                          {% set main_light = 'light.' ~ room_key %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room_key ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {% if numbered_lights | length == 1 and main_light in all_lights %}
                            {% set _ = room_lights.append(numbered_lights[0]) %}
                          {% elif numbered_lights | length > 1 %}
                            {% for light_id in numbered_lights %}
                              {% set _ = room_lights.append(light_id) %}
                            {% endfor %}
                          {% elif main_light in all_lights %}
                            {% set _ = room_lights.append(main_light) %}
                          {% else %}
                            {% for light_id in numbered_lights %}
                              {% set _ = room_lights.append(light_id) %}
                            {% endfor %}
                          {% endif %}
                        {% endif %}
                        {{ room_lights }}
                      {% else %}
                        []
                      {% endif %}

          # Individual Lights - dynamically discovered based on selected room
          - type: conditional
            conditions:
              - entity: input_select.room_selector
                state_not: unknown
            card:
              type: grid
              square: false
              columns: 2
              cards:
                # Show individual light if room group contains only one light (e.g., light.living_room with only light.fixture)
                # Check if the group entity has entity_id attribute (which contains members) with only one member
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' %}
                          {% set room_key = room %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set main_light = 'light.' ~ room_key %}
                          {% if room_key == 'hallway' %}
                            {{ false }}
                          {% elif main_light in all_lights %}
                            {% set main_light_attr = state_attr(main_light, 'entity_id') | default([]) %}
                            {% if main_light_attr is iterable and main_light_attr is not string %}
                              {# Check if it's a list/array with exactly one item #}
                              {{ main_light_attr | list | length == 1 }}
                            {% else %}
                              {{ false }}
                            {% endif %}
                          {% else %}
                            {{ false }}
                          {% endif %}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      {% if room and room != 'unknown' and room != 'unavailable' %}
                        {% set room_key = room %}
                        {% set main_light = 'light.' ~ room_key %}
                        {% set main_light_attr = state_attr(main_light, 'entity_id') | default([]) %}
                        {% if main_light_attr is iterable and main_light_attr is not string %}
                          {% set attr_list = main_light_attr | list %}
                          {{ attr_list[0] if attr_list | length == 1 else main_light }}
                        {% else %}
                          {{ main_light }}
                        {% endif %}
                      {% else %}
                        light.bedroom
                      {% endif %}
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }}
                # Smart logic: if only one numbered light exists with main, show numbered only
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' %}
                          {% set room_key = room %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set main_light = 'light.' ~ room_key %}
                          {% if room_key == 'hallway' %}
                            {{ false }}
                          {% else %}
                            {% set main_light_entities = state_attr(main_light, 'entity_id') | default([]) %}
                            {% set numbered_lights = [] %}
                            {% for i in range(1, 10) %}
                              {% set numbered_light = 'light.' ~ room_key ~ '_' ~ i %}
                              {% if numbered_light in all_lights %}
                                {% set _ = numbered_lights.append(numbered_light) %}
                              {% endif %}
                            {% endfor %}
                            {{ numbered_lights | length == 1 and main_light in all_lights and (main_light_entities | length != 1) }}
                          {% endif %}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      {% set room_key = room %}
                      {% set all_lights = states.light | map(attribute='entity_id') | list %}
                      {% set numbered_lights = [] %}
                      {% for i in range(1, 10) %}
                        {% set numbered_light = 'light.' ~ room_key ~ '_' ~ i %}
                        {% if numbered_light in all_lights %}
                          {% set _ = numbered_lights.append(numbered_light) %}
                        {% endif %}
                      {% endfor %}
                      {{ numbered_lights[0] if numbered_lights | length == 1 else 'light.' ~ room_key }}
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }}
                # Show main light if it exists, has multiple entities (not a single-member group), and (no numbered or multiple numbered)
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' %}
                          {% set room_key = room %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% if room_key == 'hallway' %}
                            {{ false }}
                          {% else %}
                            {% set main_light = 'light.' ~ room_key %}
                            {% if main_light in all_lights %}
                              {# Check if main_light is a group with only one member #}
                              {% set main_light_entities = state_attr(main_light, 'entity_id') | default([]) %}
                              {% if main_light_entities is iterable and main_light_entities is not string %}
                                {% set entity_list = main_light_entities | list %}
                                {% if entity_list | length == 1 %}
                                  {{ false }}  {# Hide group if it only contains one light #}
                                {% else %}
                                  {% set numbered_lights = [] %}
                                  {% for i in range(1, 10) %}
                                    {% set numbered_light = 'light.' ~ room_key ~ '_' ~ i %}
                                    {% if numbered_light in all_lights %}
                                      {% set _ = numbered_lights.append(numbered_light) %}
                                    {% endif %}
                                  {% endfor %}
                                  {{ numbered_lights | length == 0 or numbered_lights | length > 1 }}
                                {% endif %}
                              {% else %}
                                {# Not a group or can't determine members, show the group normally #}
                                {% set numbered_lights = [] %}
                                {% for i in range(1, 10) %}
                                  {% set numbered_light = 'light.' ~ room_key ~ '_' ~ i %}
                                  {% if numbered_light in all_lights %}
                                    {% set _ = numbered_lights.append(numbered_light) %}
                                  {% endif %}
                                {% endfor %}
                                {{ numbered_lights | length == 0 or numbered_lights | length > 1 }}
                              {% endif %}
                            {% else %}
                              {{ false }}
                            {% endif %}
                          {% endif %}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      {% if room and room != 'unknown' and room != 'unavailable' %}
                        light.{{ room }}
                      {% else %}
                        light.bedroom
                      {% endif %}
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }}
                # Show numbered lights if they exist (for multiple numbered lights case)
                # Dynamically check numbered lights 1-9 based on selected room
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {{ numbered_lights | length > 1 }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {{ states('light.' ~ room ~ '_1') != 'unavailable' }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      light.{{ room }}_1
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }} Light 1
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {{ numbered_lights | length > 1 }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {{ states('light.' ~ room ~ '_2') != 'unavailable' }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      light.{{ room }}_2
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }} Light 2
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {{ numbered_lights | length > 1 }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {{ states('light.' ~ room ~ '_3') != 'unavailable' }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      light.{{ room }}_3
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }} Light 3
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {{ numbered_lights | length > 1 }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {{ states('light.' ~ room ~ '_4') != 'unavailable' }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      light.{{ room }}_4
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }} Light 4
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {{ numbered_lights | length > 1 }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {{ states('light.' ~ room ~ '_5') != 'unavailable' }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      light.{{ room }}_5
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }} Light 5
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {{ numbered_lights | length > 1 }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {{ states('light.' ~ room ~ '_6') != 'unavailable' }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      light.{{ room }}_6
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }} Light 6
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {{ numbered_lights | length > 1 }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {{ states('light.' ~ room ~ '_7') != 'unavailable' }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      light.{{ room }}_7
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }} Light 7
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {{ numbered_lights | length > 1 }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {{ states('light.' ~ room ~ '_8') != 'unavailable' }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      light.{{ room }}_8
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }} Light 8
                - type: conditional
                  conditions:
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set numbered_lights = [] %}
                          {% for i in range(1, 10) %}
                            {% set numbered_light = 'light.' ~ room ~ '_' ~ i %}
                            {% if numbered_light in all_lights %}
                              {% set _ = numbered_lights.append(numbered_light) %}
                            {% endif %}
                          {% endfor %}
                          {{ numbered_lights | length > 1 }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                    - condition: template
                      value_template: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' and room != 'hallway' %}
                          {{ states('light.' ~ room ~ '_9') != 'unavailable' }}
                        {% else %}
                          {{ false }}
                        {% endif %}
                  card:
                    type: light
                    entity: >
                      {% set room = states('input_select.room_selector') %}
                      light.{{ room }}_9
                    name: >
                      {% set room = states('input_select.room_selector') %}
                      {{ room | replace('_', ' ') | title }} Light 9
                # Hallway special case
                - type: conditional
                  conditions:
                    - entity: input_select.room_selector
                      state: hallway
                    - condition: template
                      value_template: "{{ states('light.hallway') != 'unavailable' }}"
                  card:
                    type: light
                    entity: light.hallway
                    name: Hallway
                - type: conditional
                  conditions:
                    - entity: input_select.room_selector
                      state: hallway
                    - condition: template
                      value_template: "{{ states('light.entrance_lights') != 'unavailable' }}"
                  card:
                    type: light
                    entity: light.entrance_lights
                    name: Entrance Lights

          # Scene Creation Section
          - type: markdown
            title: Create Scene
            content: |
              Adjust the lights above to your desired settings, then:
              1. Enter a scene name below
              2. Click "Create Scene" to save the current state

          # Scene Creation - dynamically discovered lights
          - type: conditional
            conditions:
              - entity: input_select.room_selector
                state_not: unknown
            card:
              type: entities
              title: >
                {% set room = states('input_select.room_selector') %}
                {% if room and room != 'unknown' and room != 'unavailable' %}
                  {{ room | replace('_', ' ') | title }} Scene Creation
                {% else %}
                  Scene Creation
                {% endif %}
              entities:
                - entity: >
                    {% set room = states('input_select.room_selector') %}
                    {% if room and room != 'unknown' and room != 'unavailable' %}
                      input_text.scene_name_{{ room }}
                    {% else %}
                      input_text.scene_name_bedroom
                    {% endif %}
                  name: Scene Name
                - type: button
                  name: Create Scene from Current Lights
                  icon: mdi:content-save
                  tap_action:
                    action: call-service
                    service: script.create_scene_from_lights
                    service_data:
                      scene_name: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' %}
                          {{ states('input_text.scene_name_' ~ room) }}
                        {% else %}
                          {{ states('input_text.scene_name_bedroom') }}
                        {% endif %}
                      scene_id: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' %}
                          {{ room }}_{{ states('input_text.scene_name_' ~ room) | lower | replace(' ', '_') }}
                        {% else %}
                          bedroom_{{ states('input_text.scene_name_bedroom') | lower | replace(' ', '_') }}
                        {% endif %}
                      light_entities: >
                        {% set room = states('input_select.room_selector') %}
                        {% if room and room != 'unknown' and room != 'unavailable' %}
                          {% set room_key = room %}
                          {% set all_lights = states.light | map(attribute='entity_id') | list %}
                          {% set room_lights = [] %}
                          {% if room_key == 'hallway' %}
                            {% for light_id in ['light.hallway', 'light.entrance_lights'] %}
                              {% if light_id in all_lights %}
                                {% set _ = room_lights.append(light_id) %}
                              {% endif %}
                            {% endfor %}
                          {% else %}
                            {% set main_light = 'light.' ~ room_key %}
                            {% set numbered_lights = [] %}
                            {% for i in range(1, 10) %}
                              {% set numbered_light = 'light.' ~ room_key ~ '_' ~ i %}
                              {% if numbered_light in all_lights %}
                                {% set _ = numbered_lights.append(numbered_light) %}
                              {% endif %}
                            {% endfor %}
                            {% if numbered_lights | length == 1 and main_light in all_lights %}
                              {% set _ = room_lights.append(numbered_lights[0]) %}
                            {% elif numbered_lights | length > 1 %}
                              {% for light_id in numbered_lights %}
                                {% set _ = room_lights.append(light_id) %}
                              {% endfor %}
                            {% elif main_light in all_lights %}
                              {% set _ = room_lights.append(main_light) %}
                            {% else %}
                              {% for light_id in numbered_lights %}
                                {% set _ = room_lights.append(light_id) %}
                              {% endfor %}
                            {% endif %}
                          {% endif %}
                          {{ room_lights }}
                        {% else %}
                          []
                        {% endif %}
