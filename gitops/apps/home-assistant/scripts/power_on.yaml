scheduled_light_on:
  alias: Scheduled Light On (safe)
  mode: restart
  fields:
    room_key: {}
    custom_schedule_enabled: { required: false }
    custom_s1_start: { required: false }
    custom_s2_start: { required: false }
    custom_s3_start: { required: false }
    custom_s4_start: { required: false }
    transition: { required: false }
    fallback_lights:
      description: Optional light/group to turn on if scene missing
      required: false
  sequence:
    - variables:
        default_s1: "06:00:00"
        default_s2: "09:00:00"
        default_s3: "17:00:00"
        default_s4: "22:00:00"

        use_custom: >-
          {{ custom_schedule_enabled is defined and is_state(custom_schedule_enabled, 'on') }}

        s1_str: >-
          {% set v = states(custom_s1_start) if use_custom else default_s1 %}
          {{ default_s1 if v in ['unknown','unavailable','', None] else v }}
        s2_str: >-
          {% set v = states(custom_s2_start) if use_custom else default_s2 %}
          {{ default_s2 if v in ['unknown','unavailable','', None] else v }}
        s3_str: >-
          {% set v = states(custom_s3_start) if use_custom else default_s3 %}
          {{ default_s3 if v in ['unknown','unavailable','', None] else v }}
        s4_str: >-
          {% set v = states(custom_s4_start) if use_custom else default_s4 %}
          {{ default_s4 if v in ['unknown','unavailable','', None] else v }}

        now_ts: "{{ as_timestamp(now()) }}"
        s1: "{{ as_timestamp(today_at(s1_str)) }}"
        s2: "{{ as_timestamp(today_at(s2_str)) }}"
        s3: "{{ as_timestamp(today_at(s3_str)) }}"
        s4: "{{ as_timestamp(today_at(s4_str)) }}"

        slot: >-
          {% if now_ts >= s1 and now_ts < s2 %}morning
          {% elif now_ts >= s2 and now_ts < s3 %}day
          {% elif now_ts >= s3 and now_ts < s4 %}evening
          {% else %}night{% endif %}

        _override_select: "{{ 'input_select.' ~ room_key ~ '_' ~ slot ~ '_scene' }}"
        _override_val: >-
          {% set val = states(_override_select) %}
          {{ '' if val in ['unknown','unavailable','', None] else val }}

        default_scene_entity_id: "scene.{{ room_key }}_{{ slot }}"
        scene_to_activate: "{{ _override_val if _override_val else default_scene_entity_id }}"

        all_scenes: "{{ states.scene | map(attribute='entity_id') | list }}"
        scene_exists: "{{ scene_to_activate in all_scenes }}"

        # Dynamic fallback: prefer light.<room_key>, then light.<room_key>_lights, else provided fallback_lights
        _light_room: "light.{{ room_key }}"
        _light_room_lights: "light.{{ room_key }}_lights"
        _all_lights: "{{ states.light | map(attribute='entity_id') | list }}"
        dynamic_fallback: >-
          {% if _light_room in _all_lights %}{{ _light_room }}
          {% elif _light_room_lights in _all_lights %}{{ _light_room_lights }}
          {% elif fallback_lights is defined and fallback_lights and fallback_lights in _all_lights %}
            {{ fallback_lights }}
          {% else %}{{ '' }}
          {% endif %}
    - choose:
        - conditions: "{{ scene_exists }}"
          sequence:
            - service: scene.turn_on
              data:
                transition: "{{ transition | default(0) }}"
              target:
                entity_id: "{{ scene_to_activate }}"
      default:
        - choose:
            - conditions: "{{ dynamic_fallback != '' }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: "{{ dynamic_fallback }}"
                - service: logbook.log
                  data:
                    name: "scheduled_light_on"
                    message: "Scene '{{ scene_to_activate }}' missing; used '{{ dynamic_fallback }}'"
                    entity_id: "{{ dynamic_fallback }}"
          default:
            - service: logbook.log
              data:
                name: "scheduled_light_on"
                message: "Scene '{{ scene_to_activate }}' missing; no fallback light entity available"
