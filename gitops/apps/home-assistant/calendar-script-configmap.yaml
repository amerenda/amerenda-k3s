apiVersion: v1
kind: ConfigMap
metadata:
  name: home-assistant-calendar-script
  namespace: home-assistant
  annotations:
    reloader.stakater.com/auto: "false"  # Exclude from Reloader - only used by CronJob
data:
  download_calendar.sh: |
    #!/bin/sh
    set -e
    
    CALENDAR_URL="https://outlook.office365.com/owa/calendar/96b4509ebff1403fb979cc5d1a19b192@jainglobal.com/2ba2f72869cd482e99af95f77b227b7e17421443293132355961/calendar.ics"
    OUTPUT_FILE="/config/.storage/local_calendar.work.ics"
    TEMP_FILE="${OUTPUT_FILE}.tmp"
    
    # Ensure .storage directory exists
    mkdir -p /config/.storage
    
    echo "[Calendar-Cache] Starting calendar download from ${CALENDAR_URL}"
    
    # Download calendar to temporary file
    if curl -f -s -S --max-time 30 -o "${TEMP_FILE}" "${CALENDAR_URL}"; then
        # Verify it's a valid ICS file (check for BEGIN:VCALENDAR)
        if head -n 1 "${TEMP_FILE}" | grep -q "BEGIN:VCALENDAR"; then
            # Move temp file to final location atomically
            mv "${TEMP_FILE}" "${OUTPUT_FILE}"
            echo "[Calendar-Cache] Successfully downloaded and cached calendar to ${OUTPUT_FILE}"
            # Show file size for verification
            ls -lh "${OUTPUT_FILE}"
        else
            echo "[Calendar-Cache] ERROR: Downloaded file does not appear to be a valid ICS file"
            rm -f "${TEMP_FILE}"
            exit 1
        fi
    else
        echo "[Calendar-Cache] ERROR: Failed to download calendar from ${CALENDAR_URL}"
        rm -f "${TEMP_FILE}"
        exit 1
    fi

