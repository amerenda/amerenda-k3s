---
# ConfigMap: init script to create 'unifi' user and grant dbOwner on 'unifi_stat'
# This is a hacky workaround, Ubiquiti, do better.
# Note: Scripts in /docker-entrypoint-initdb.d only run on first initialization
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongo-init-grant
  namespace: unifi-network-application
data:
  zzz-grant-unifi-stat.sh: |
    #!/bin/bash
    set -e
    echo "[INFO] Creating 'unifi' user and granting dbOwner on 'unifi_stat'..."
    
    # Get root password from environment
    ROOT_USER="${MONGO_INITDB_ROOT_USERNAME:-root}"
    ROOT_PASS="${MONGO_INITDB_ROOT_PASSWORD}"
    UNIFI_PASS="${MONGO_INITDB_ROOT_PASSWORD}"
    
    # Create unifi user in admin database and grant permissions
    # This runs during MongoDB initialization (before auth is enabled)
    # Use mongo (not mongosh) for MongoDB 4.4.10
    # User is created in admin database but has roles on unifi and unifi_stat databases
    mongo --quiet <<EOF
    use admin
    
    // Create the unifi user in admin database
    db.createUser({
      user: "unifi",
      pwd: "${UNIFI_PASS}",
      roles: [
        { role: "dbOwner", db: "unifi" },
        { role: "dbOwner", db: "unifi_stat" }
      ]
    });
    print("[INFO] Created 'unifi' user in admin database with dbOwner on 'unifi' and 'unifi_stat'");
    EOF
    
    echo "[INFO] Done setting up 'unifi' user."

