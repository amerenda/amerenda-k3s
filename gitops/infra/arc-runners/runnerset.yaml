apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerSet
metadata:
  name: arc-runner-set
  namespace: arc-systems
  annotations:
    argocd.argoproj.io/sync-wave: "5"
spec:
  # GitHub configuration - repository-level (required for personal accounts)
  # Personal GitHub accounts cannot use organization-level runners
  repository: amerenda/amerenda-k3s
  githubAPICredentialsFrom:
    secretRef:
      name: controller-manager
  
  # Runner image
  image: ghcr.io/actions/actions-runner:latest
  
  # Runner labels (must match runs-on in workflows)
  labels:
    - self-hosted
    - linux
    - arc-runner-set
  
  # Docker configuration for container jobs
  dockerdWithinRunnerContainer: true
  dockerEnabled: true
  
  # Ephemeral runners - exit after completing jobs, HRA will scale up based on demand
  ephemeral: true
  
  # Replica configuration - HRA will manage scaling dynamically
  # For ephemeral runners, set to 0 and let HRA scale based on demand
  # HRA minReplicas (1) ensures at least 1 runner stays up even when idle
  replicas: 0
  
  # Service name (required)
  serviceName: arc-runner-set
  
  # Selector (required)
  selector:
    matchLabels:
      runner-template: arc-runner-set
  
  # Pod template
  template:
    metadata:
      labels:
        runner-template: arc-runner-set
    spec:
      # Service account
      serviceAccountName: arc-runner-set
      
      # Security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      
      # Containers
      containers:
      - name: runner
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
