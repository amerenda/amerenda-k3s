# Longhorn Helm Chart Values

# Install CRDs automatically
installCRDs: true

# Global tolerations and node selector for Longhorn components
tolerations:
  - key: "longhorn.io/storage"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"
  - key: "longhorn.io/storage"
    operator: "Equal"
    value: "true"
    effect: "NoExecute"

nodeSelector:
  longhorn.io/storage: "true"

# Longhorn configuration
longhorn:
  # Enable Longhorn manager
  manager:
    enabled: true
    replicas: 1
    
  # Storage class configuration
  storageClass:
    name: longhorn
    defaultClass: true
    reclaimPolicy: Delete
    allowVolumeExpansion: true
    volumeBindingMode: Immediate
    
  # Resource limits for Pi hardware
  resources:
    manager:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    ui:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi
        
  # Longhorn settings for two-tier storage system
  settings:
    default-replica-count: "2"
    system-managed-components-node-selector: "longhorn.io/storage-preference=true"
    replica-auto-balance: "disabled"
    concurrent-replica-rebuild-per-node-limit: "2"
    concurrent-automatic-engine-upgrade-per-node-limit: "1"
    disable-scheduling-on-cordoned-node: "true"
    node-drain-policy: "block-if-contains-last-replica"
    # Storage gate - only nodes with longhorn.io/storage=true can store data
    create-default-disk-labeled-nodes: "false"
    # Prefer replicas on storage preference nodes (rpi3-0)
    replica-soft-anti-affinity: "false"
    replica-hard-anti-affinity: "false"

# Disable pre-upgrade hook to avoid service account dependency issues
preUpgradeChecker:
  jobEnabled: false

# Default backup store configuration
defaultBackupStore:
  # Endpoint used to access the default backupstore
  backupTarget: s3://amerenda-backups@us/k3s/dean
  # Name of the Kubernetes secret associated with the default backup target
  backupTargetCredentialSecret: gcs-backup-credentials
  # Number of seconds that Longhorn waits before checking the default backupstore for new backups
  pollInterval: 300

# Additional manifests to apply after Longhorn installation
extraManifests:
  - apiVersion: batch/v1
    kind: Job
    metadata:
      name: longhorn-settings-applier
      namespace: default
      annotations:
        argocd.argoproj.io/sync-wave: "4"  # After Longhorn is running
      labels:
        app: longhorn-settings-applier
    spec:
      template:
        spec:
          serviceAccountName: longhorn-settings-applier
          containers:
          - name: settings-applier
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              set -e
              echo "Waiting for Longhorn to be ready..."
              kubectl wait --for=condition=ready pod -l app=longhorn-manager --timeout=300s
              
              echo "Applying Longhorn settings..."
              
              # Apply node selector for system components (prefer storage nodes)
              kubectl patch settings.longhorn.io system-managed-components-node-selector \
                --type merge -p '{"value": "longhorn.io/storage-preference=true"}' || echo "Setting already configured"
              
              # Verify system components node selector
              echo "Current system-managed-components-node-selector:"
              kubectl get settings.longhorn.io system-managed-components-node-selector -o jsonpath='{.value}' || echo "Setting not found"
              
              # Apply taint tolerations
              kubectl patch settings.longhorn.io taint-toleration \
                --type merge -p '{"value": "longhorn.io/storage=true:NoSchedule,longhorn.io/storage=true:NoExecute"}' || echo "Setting already configured"
              
              # Configure storage gate - only nodes with longhorn.io/storage=true can store data
              kubectl patch settings.longhorn.io create-default-disk-labeled-nodes \
                --type merge -p '{"value": "false"}' || echo "Setting already configured"
              
              # Apply storage optimization settings
              kubectl patch settings.longhorn.io storage-minimal-available-percentage \
                --type merge -p '{"value": "25"}' || echo "Setting already configured"
              
              kubectl patch settings.longhorn.io storage-reserved-percentage-for-default-disk \
                --type merge -p '{"value": "30"}' || echo "Setting already configured"
              
              kubectl patch settings.longhorn.io disable-scheduling-on-cordoned-node \
                --type merge -p '{"value": "true"}' || echo "Setting already configured"
              
              kubectl patch settings.longhorn.io node-drain-policy \
                --type merge -p '{"value": "block-if-contains-last-replica"}' || echo "Setting already configured"
              
              # Configure replica scheduling preferences
              kubectl patch settings.longhorn.io replica-soft-anti-affinity \
                --type merge -p '{"value": "false"}' || echo "Setting already configured"
              
              kubectl patch settings.longhorn.io replica-hard-anti-affinity \
                --type merge -p '{"value": "false"}' || echo "Setting already configured"
              
              # Verify two-tier storage configuration
              echo "Verifying two-tier storage configuration..."
              kubectl get settings.longhorn.io create-default-disk-labeled-nodes -o jsonpath='{.value}' || echo "Storage gate setting not found"
              
              echo "Longhorn settings applied successfully!"
              echo "Two-tier storage system:"
              echo "  - Storage gate: Only nodes with longhorn.io/storage=true can store data"
              echo "  - Storage preference: Nodes with longhorn.io/storage-preference=true are preferred"
          restartPolicy: OnFailure
      backoffLimit: 3
  - apiVersion: v1
    kind: ServiceAccount
    metadata:
      name: longhorn-settings-applier
      namespace: default
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: longhorn-settings-applier
    rules:
    - apiGroups: ["longhorn.io"]
      resources: ["settings"]
      verbs: ["get", "list", "patch", "update"]
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list", "watch"]
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: longhorn-settings-applier
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: ClusterRole
      name: longhorn-settings-applier
    subjects:
    - kind: ServiceAccount
      name: longhorn-settings-applier
      namespace: default

service:
  ui:
    type: LoadBalancer
    annotations:
      external-dns.alpha.kubernetes.io/hostname: longhorn.amer.home
      external-dns.alpha.kubernetes.io/ttl: "300"
